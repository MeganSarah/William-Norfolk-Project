---
title: "Bivariate Analysis"
author: "William Norfolk"
date: "11/3/2019"
output: word_document
---

This script runs bivariate/deeper analysis of the water quality dataset to produce additional/complex data visualizations. This script operates using the _processed_data_ file produced via running the _WQprocessing_ script located inside the _code_ folder and _processing_code_ subfolder loacted within this project.

Start by loading required libraries
```{r load libs}
library(readxl)
library(dplyr)
library(tidyverse)
library(forcats)
library(ggthemes)
library(plotly)
library(knitr)
library(naniar)
library(broom)
library(gridExtra)
library(zoo)
library(ggpubr)

```


Load the data and take a look at the variables.

```{r load data}

WQ_clean_data <- readRDS("../../data/processed_data/processeddata.rds")

glimpse(WQ_clean_data)

```

Lets start by taking a look at the five water quality parameters plotted against one another with bivariate visualizations. For this data we will use jitter plots.

```{r WQ params vs each other}
temp_and_salt <- ggplot(WQ_clean_data, aes(x = salinity, y = water_temp, color = island_side)) + geom_jitter()

temp_and_salt

temp_and_ph <- ggplot(WQ_clean_data, aes(x = ph, y = water_temp, color = island_side)) + geom_jitter()

temp_and_ph

temp_and_do <- ggplot(WQ_clean_data, aes(x = dissolved_oxygen, y = water_temp, color = island_side)) + geom_jitter()

temp_and_do

temp_and_ammonia <- ggplot(WQ_clean_data, aes(x = ammonia, y = water_temp, color = island_side)) + geom_jitter()

temp_and_ammonia

salt_and_ph <- ggplot(WQ_clean_data, aes(x = salinity, y = ph, color = island_side)) + geom_jitter()

salt_and_ph

salt_and_do <- ggplot(WQ_clean_data, aes(x = salinity, y = dissolved_oxygen, color = island_side)) + geom_jitter()

salt_and_do

salt_and_ammonia <- ggplot(WQ_clean_data, aes(x = salinity, y = ammonia, color = island_side)) + geom_jitter()

salt_and_ammonia

ph_and_do <- ggplot(WQ_clean_data, aes(x = ph, y = dissolved_oxygen, color = island_side)) + geom_jitter()

ph_and_do

ph_and_ammonia <- ggplot(WQ_clean_data, aes(x = ph, y = ammonia, color = island_side)) + geom_jitter()

ph_and_ammonia

do_and_ammonia <- ggplot(WQ_clean_data, aes(x = ammonia, y = dissolved_oxygen, color = island_side)) + geom_jitter()

do_and_ammonia

```

It looks like these comparisons are not terribly informative. This is not suprising due to the geographic spread of the site locations. While ocean waters and bay waters are quite different interms of abiotic conditions, typically the difference is primairly apparent when viewing the range of abiotic conditions rather than individual correlations. These ranges are better visualized with the violin-jitter plots produced in the _Exploratory_Data_Analysis_Location_ script. 

It may be more informative to view seasonal and annual changes in conditions using bivariate analysis. We will break down the information for each year and predictor to get a more in depth visualization of seasonality.

We will start with monthly data to view seasons.

```{r year subsets}
year_16 <- subset(WQ_clean_data, Year == "16")
year_17 <- subset(WQ_clean_data, Year == "17")
year_18 <- subset(WQ_clean_data, Year == "18")
year_19 <- subset(WQ_clean_data, Year == "19")

#To scale all figures to same axis
year_16$Month <- as.numeric(as.character(year_16$Month))
year_17$Month <- as.numeric(as.character(year_17$Month))
year_18$Month <- as.numeric(as.character(year_18$Month))
year_19$Month <- as.numeric(as.character(year_19$Month))

#To get rid of clutter in the figures
year_16 <- year_16[!is.na(year_16$island_side), ]
year_17 <- year_17[!is.na(year_17$island_side), ]
year_18 <- year_18[!is.na(year_18$island_side), ]
year_19 <- year_19[!is.na(year_19$island_side), ]
```


```{r water temp seasonality}

month_vs_temp_16 <- ggplot(year_16, aes(x = Month, y = water_temp, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(15, 40)) + geom_smooth(se = FALSE) + xlab("Month (2016)") + ylab("Water Temperature (C)")

month_vs_temp_16 

month_vs_temp_17 <- ggplot(year_17, aes(x = Month, y = water_temp, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(15, 40)) + geom_smooth(se = FALSE) + xlab("Month (2017)") + ylab("Water Temperature (C)")

month_vs_temp_17


month_vs_temp_18 <- ggplot(year_18, aes(x = Month, y = water_temp, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(15, 40)) + geom_smooth(se = FALSE) + xlab("Month (2018)") + ylab("Water Temperature (C)")

month_vs_temp_18

month_vs_temp_19 <- ggplot(year_19, aes(x = Month, y = water_temp, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(15, 40)) + geom_smooth(se = FALSE) + xlab("Month (2019)") + ylab("Water Temperature (C)")

month_vs_temp_19

ggarrange(month_vs_temp_16, month_vs_temp_17, month_vs_temp_18, month_vs_temp_19, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")

```

From the looks of these figures it seems that temperature fluctuates in a manner that is to be expected (i.e. cold in the winter and warmer in the summer). It is also pretty consistent that the temperature range is greater for the bayside waters than the ocean side waters which is consistent withe previously generated violin plots from _Exploratory_Data_Analysis_Seasonal_.

```{r}
month_vs_sal_16 <- ggplot(year_16, aes(x = Month, y = salinity, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(15, 40)) + geom_smooth(se = FALSE) + xlab("Month (2016)") + ylab("Salinity (ppt)")

month_vs_sal_16 

month_vs_sal_17 <- ggplot(year_17, aes(x = Month, y = salinity, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(15, 40)) + geom_smooth(se = FALSE) + xlab("Month (2017)") + ylab("Salinity (ppt)")

month_vs_sal_17


month_vs_sal_18 <- ggplot(year_18, aes(x = Month, y = salinity, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(15, 40)) + geom_smooth(se = FALSE) + xlab("Month (2018)") + ylab("Salinity (ppt)")

month_vs_sal_18

month_vs_sal_19 <- ggplot(year_19, aes(x = Month, y = salinity, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(15, 40)) + geom_smooth(se = FALSE) + xlab("Month (2019)") + ylab("Salinity (ppt)")

month_vs_sal_19

ggarrange(month_vs_sal_16, month_vs_sal_17, month_vs_sal_18, month_vs_sal_19, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```
Salinity loos pretty consistent with the exploratory plots as well. Ocean side water are consistently higher in salinity than the bay side, which is expected since the bay is an estuary. Additionally, there is wa wider range of salinity on the bay side, this is consistent with exploratory analysis. There is an odd jump in the salinity around April. This may simply be a result of few observations taken during that time or it is possibly due to a very low rainfall year (salinitly tends to spike in the bay when rainfall is reduced). We will explore this further in discussion.


```{r}
month_vs_do_16 <- ggplot(year_16, aes(x = Month, y = dissolved_oxygen, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(1, 10)) + geom_smooth(se = FALSE) + xlab("Month (2016)") + ylab("Dissolved Oxygen (mg/L")

month_vs_do_16 

month_vs_do_17 <- ggplot(year_17, aes(x = Month, y = dissolved_oxygen, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(1, 10)) + geom_smooth(se = FALSE) + xlab("Month (2017)") + ylab("Dissolved Oxygen (mg/L")

month_vs_do_17


month_vs_do_18 <- ggplot(year_18, aes(x = Month, y = dissolved_oxygen, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(1, 10)) + geom_smooth(se = FALSE) + xlab("Month (2018)") + ylab("Dissolved Oxygen (mg/L")

month_vs_do_18

month_vs_do_19 <- ggplot(year_19, aes(x = Month, y = dissolved_oxygen, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(1, 10)) + geom_smooth(se = FALSE) + xlab("Month (2019)") + ylab("Dissolved Oxygen (mg/L")

month_vs_do_19

ggarrange(month_vs_do_16, month_vs_do_17, month_vs_do_18, month_vs_do_19, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```

Dissolved oxygen does not appear to show any distict patterns across all years sampled. Though the 2019 plot does show clearly a large upswing in total number of observations taken. 



```{r}
month_vs_amm_16 <- ggplot(year_16, aes(x = Month, y = ammonia, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(0, 0.3)) + geom_smooth(se = FALSE) + xlab("Month (2016)") + ylab("Ammonia (mg/L)")

month_vs_amm_16 

month_vs_amm_17 <- ggplot(year_17, aes(x = Month, y = ammonia, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(0, 0.3)) + geom_smooth(se = FALSE) + xlab("Month (2017)") + ylab("Ammonia (mg/L)")

month_vs_amm_17


month_vs_amm_18 <- ggplot(year_18, aes(x = Month, y = ammonia, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(0, 0.3)) + geom_smooth(se = FALSE) + xlab("Month (2018)") + ylab("Ammonia (mg/L)")

month_vs_amm_18

month_vs_amm_19 <- ggplot(year_19, aes(x = Month, y = ammonia, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(0, 0.3)) + geom_smooth(se = FALSE) + xlab("Month (2019)") + ylab("Ammonia (mg/L)")

month_vs_amm_19

ggarrange(month_vs_amm_16, month_vs_amm_17, month_vs_amm_18, month_vs_amm_19, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```
Ammonia appears quite interesting. Most of the observations are fairly consistent with very low to negligable ammonia levels in the water. There is a distinct increase in fall 2017 which is consistent with the timing of Hurricane Irma landfall.

```{r}
month_vs_ph_16 <- ggplot(year_16, aes(x = Month, y = ph, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(7, 9)) + geom_smooth(se = FALSE) + xlab("Month (2016)") + ylab("pH")

month_vs_ph_16 

month_vs_ph_17 <- ggplot(year_17, aes(x = Month, y = ph, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(7, 9)) + geom_smooth(se = FALSE) + xlab("Month (2017)") + ylab("pH")

month_vs_ph_17


month_vs_ph_18 <- ggplot(year_18, aes(x = Month, y = ph, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(7, 9)) + geom_smooth(se = FALSE) + xlab("Month (2018)") + ylab("pH")

month_vs_ph_18

month_vs_ph_19 <- ggplot(year_19, aes(x = Month, y = ph, color = island_side)) + geom_jitter(alpha = 0.25) + scale_x_continuous(limits=c(1, 12), breaks = 1:12) + scale_y_continuous(limits=c(7, 9)) + geom_smooth(se = FALSE) + xlab("Month (2019)") + ylab("pH")

month_vs_ph_19

ggarrange(month_vs_ph_16, month_vs_ph_17, month_vs_ph_18, month_vs_ph_19, nrow = 2, ncol = 2, common.legend = TRUE, legend = "bottom")
```
pH visualization does not show any distinct patterns across various seasons of measurement. This is consistent with expected results due to the fact that both the ocean and bay are strongly influenced by the alkaline limestone bedrock of the Keys. 

Overall, the there seems to be little seasonal fluctuation in ammonia, dissolved oxygen and pH measurements. This is not suprising due to the fact that these parameters are largely independent of one another (barring some unique event). Water temperature shows standard seasonal fluctuation with warmer and cooler months, and bays side waters exhibit a wider ranger of temperatures. Salinity is reasonable unique in terms of observations. Oceanside water have distinctly greater salinity for the vast majority of the year and have a very narrow range. Bayside waters typically have a reduced salinity, however large spikes upward can be associated with the dry season. 

Despite these overall trends, there is a notable break in most of the parameters consistent with the timing of Hurricane Irma landfall (September 2017). Ammonia most noteably spkies drastically at this time. This is likely due to hurricane-induced nutrint influx. Salinity drops substantially from the normal levels, likely due to storm water influx. Water temperature shows a notable decrease, but it is likely this can be attributed to standard seasonal fluctuation. Both pH and dissolved oxygen do not show any unusual trends during this time. This is a suprising result for dissolved oxygen. It should be noted that post Hirricane Irma observations are limited in number due to the inability to collect samples directly following the storm. 

Since we can see these trends visually, lets see if there is a significant difference between the fall 2017 and the fall season of the other years.


############Test statistical significance of the months surrounding Irma?


Lets take a step closer in and take a look at seasonal changes by individual site. Here we will use raster plots to visualize the "heat" differences in water quality parameter. To avoid clutter we will drop NAs from the individual predictors. The will not provide much information in these plots if they are not present. 

```{r remove NA predictor values}
temp_drop_na <- WQ_clean_data[!is.na(WQ_clean_data$water_temp), ]
sal_drop_na <- WQ_clean_data[!is.na(WQ_clean_data$salinity), ]
do_drop_na <- WQ_clean_data[!is.na(WQ_clean_data$dissolved_oxygen), ]
ph_drop_na <- WQ_clean_data[!is.na(WQ_clean_data$ph), ]
amm_drop_na <- WQ_clean_data[!is.na(WQ_clean_data$ammonia), ]


```


```{r temp raster}

temp_drop_na_1 <- temp_drop_na[!is.na(temp_drop_na$island_side), ]
temp_drop_na_2 <- temp_drop_na_1[!is.na(temp_drop_na_1$site_type), ]

raster_by_site_temp <- ggplot(temp_drop_na, aes(x = Month, y = location, fill = water_temp)) + geom_raster()

raster_by_site_temp

raster_by_island_side_temp <- ggplot(temp_drop_na_1, aes(x = Month, y = island_side, fill = water_temp)) + geom_raster(interpolate = TRUE) + scale_fill_gradientn(colors = c("blue", "yellow"))

raster_by_island_side_temp

raster_by_site_type_temp <- ggplot(temp_drop_na_2, aes(x = Month, y = site_type, fill = water_temp)) + geom_raster(interpolate = TRUE) + scale_fill_gradientn(colors = c("blue", "yellow"))

raster_by_site_type_temp
```

```{r salinity raster}

sal_drop_na_1 <- sal_drop_na[!is.na(sal_drop_na$island_side), ]
sal_drop_na_2 <- sal_drop_na_1[!is.na(sal_drop_na_1$site_type), ]

raster_by_site_sal <- ggplot(sal_drop_na, aes(x = Month, y = location, fill = salinity)) + geom_raster()

raster_by_site_sal

raster_by_island_side_sal <- ggplot(sal_drop_na_1, aes(x = Month, y = island_side, fill = salinity)) + geom_raster(interpolate = TRUE) + scale_fill_gradientn(colors = c("blue", "yellow"))

raster_by_island_side_sal

raster_by_site_type_sal <- ggplot(sal_drop_na_2, aes(x = Month, y = site_type, fill = salinity)) + geom_raster(interpolate = TRUE) + scale_fill_gradientn(colors = c("blue", "yellow"))

raster_by_site_type_sal
```

```{r dissolved oxygen raster}

do_drop_na_1 <- do_drop_na[!is.na(do_drop_na$island_side), ]
do_drop_na_2 <- do_drop_na_1[!is.na(do_drop_na_1$site_type), ]

raster_by_site_do <- ggplot(do_drop_na, aes(x = Month, y = location, fill = dissolved_oxygen)) + geom_raster()

raster_by_site_do

raster_by_island_side_do <- ggplot(do_drop_na_1, aes(x = Month, y = island_side, fill = dissolved_oxygen)) + geom_raster(interpolate = TRUE) + scale_fill_gradientn(colors = c("blue", "yellow"))

raster_by_island_side_do

raster_by_site_type_do <- ggplot(do_drop_na_2, aes(x = Month, y = site_type, fill = dissolved_oxygen)) + geom_raster(interpolate = TRUE) + scale_fill_gradientn(colors = c("blue", "yellow"))

raster_by_site_type_do
```

```{r ammonia raster}

amm_drop_na_1 <- amm_drop_na[!is.na(amm_drop_na$island_side), ]
amm_drop_na_2 <- amm_drop_na_1[!is.na(amm_drop_na_1$site_type), ]

raster_by_site_amm <- ggplot(amm_drop_na, aes(x = Month, y = location, fill = ammonia)) + geom_raster()

raster_by_site_amm

raster_by_island_side_amm <- ggplot(amm_drop_na_1, aes(x = Month, y = island_side, fill = ammonia)) + geom_raster(interpolate = TRUE) + scale_fill_gradientn(colors = c("blue", "yellow"))

raster_by_island_side_amm

raster_by_site_type_amm <- ggplot(amm_drop_na_2, aes(x = Month, y = site_type, fill = ammonia)) + geom_raster(interpolate = TRUE) + scale_fill_gradientn(colors = c("blue", "yellow"))

raster_by_site_type_amm
```

```{r ph raster}

ph_drop_na_1 <- ph_drop_na[!is.na(ph_drop_na$island_side), ]
ph_drop_na_2 <- ph_drop_na_1[!is.na(ph_drop_na_1$site_type), ]

raster_by_site_ph <- ggplot(ph_drop_na, aes(x = Month, y = location, fill = ph)) + geom_raster()

raster_by_site_ph

raster_by_island_side_ph <- ggplot(ph_drop_na_1, aes(x = Month, y = island_side, fill = ph)) + geom_raster(interpolate = TRUE) + scale_fill_gradientn(colors = c("blue", "yellow"))

raster_by_island_side_ph

raster_by_site_type_ph <- ggplot(ph_drop_na_2, aes(x = Month, y = site_type, fill = ph)) + geom_raster(interpolate = TRUE) + scale_fill_gradientn(colors = c("blue", "yellow"))

raster_by_site_type_ph
```

#########################################################
Specific look at Irma year. Still working below here...

Determine raster keep or not

```{r}
irma_raster <- ggplot(year_17, aes(x = Month, y = island_side, fill = ph)) + geom_tile()

irma_raster
```











